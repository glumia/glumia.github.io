<!DOCTYPE html>
<html lang="en-US">

<head>
<meta charset="utf-8">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<meta name="description" content="glumia&#39;s blog">


    <meta property="twitter:site" content="@glumia8">

<meta property="og:site_name" content="glumia&#39;s blog" />
<meta property="og:locale" content="en-US" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://glumia.github.io/blog/c-and-assembly-subtleties/" />
<meta property="og:title" content="C and Assembly - Subtleties" />
<meta property="twitter:title" content="C and Assembly - Subtleties">

    <meta property="twitter:card" content="summary">

<meta property="og:description" content="">
<meta property="twitter:description" content="">

<title>


     glumia&#39;s blog - C and Assembly - Subtleties 

</title>
<link rel="canonical" href="https://glumia.github.io/blog/c-and-assembly-subtleties/">



<link rel="stylesheet" media="screen" href="https://glumia.github.io/main.min.dffb851d638518135951883d0cbfe45ea87314208439fb1019d07f69576040f1.css">


<link rel="stylesheet" media="(min-width: 600px)" href="https://glumia.github.io/min600px.min.58b803615fccecf3f08f98ab1ea307a53031ac82099eb884d14b256aecff0dfe.css">


<link rel="stylesheet" media="(min-width: 769px)" href="https://glumia.github.io/min769px.min.120cb35d201663ad94a3cdf59377253c32841093bc26a904c150f2037a2e074a.css">


<link rel="stylesheet" href="https://glumia.github.io/openring.min.26ec8e93ec802619ea8596084fb0b1d7632b5cc16cf403ab996fa0b1404e371b.css">



<link rel="shortcut icon"

    href="https://glumia.github.io/favicon-32x32.png"

>




</head>


<body>


<div class="header column">

    <div class="container">
        <a href="https://glumia.github.io/"><img class="logo" src="https://glumia.github.io/logo_glumia_512.jpg" alt="logo"></a>
        <div class="content">
            <a href="https://glumia.github.io/"><div class="name"><h1>glumia&#39;s blog</h1></div></a>
            <nav>
                <ul>
                    
                            <li><a href="https://glumia.github.io/blog/">Blog</a></li>
                    
                    
                        
                            
                        
                    
                    
                        
                            <li><a href="https://glumia.github.io/about/">About</a></li>
                        
                    
                </ul>
            </nav>
        </div>
    </div>
</div>



<div class="main post non-narrow zero-top-spacing column">
    <div class="container">
        <div class="content">
            <div class="front-matter">
                <div class="title-container">
                    <div class="page-heading">

    
    C and Assembly - Subtleties
    

</div>

                </div>
                <div class="meta">
                    <div class="date" title="Sun Aug 25 2019 00:00:00 UTC">Aug 25, 2019</div>
                    
                        
                    
                    
                    <div class="reading-time middot">4 minute read</div>
                    
                      <div class="tags">
                        <ul>
                          
                            <li class="middot"><a href="https://glumia.github.io/tags/c">C</a> </li>
                          
                            <li class="middot"><a href="https://glumia.github.io/tags/assembly">Assembly</a> </li>
                          
                            <li class="middot"><a href="https://glumia.github.io/tags/optimization">Optimization</a> </li>
                          
                        </ul>
                    </div>
                    <div class="tags">
                        <ul>
                          
                          
                        </ul>
                    </div>
                </div>
            </div>
            <div class="markdown">
                <h3 id="should-i-write-this">Should I write this</h3>
<pre><code>int flag = 0;		# Boolean value, can only be 0 or 1
while(some_condition){
    ...
    if(flag == 0)
            flag = 1;
    ...
}
</code></pre>
<h3 id="or">or</h3>
<pre><code>int flag = 0;
while(some_condition){
    ...
    flag = 1;
    ...
}
</code></pre>
<h3 id="what-performs-better">what performs better?</h3>
<p>While I was writing some C code I came up to this little question. In a while loop at a certain point we have to set a boolean flag&rsquo;s value to 1. So, should we check it&rsquo;s value first and eventually assign it to 1 or just assign it to 1 anyway ?</p>
<p>One misleading reasoning could be: &ldquo;better the first version since we don&rsquo;t make an assignment if it&rsquo;s not necessary!&rdquo;</p>
<p>But let&rsquo;s take a look at the assembly code generated by the two versions.</p>
<h3 id="first-version---check-and-eventually-set">First version - Check and eventually set</h3>
<pre><code>int main(){                                │        movl    $42, -8(%rbp)
        int condition = 42;                │        movl    $0, -4(%rbp)
        int flag = 0;                      │        jmp     .L2
        while(condition){                  │.L3:
                if(flag == 0)              │        cmpl    $0, -4(%rbp)
                        flag = 1;          │        jne     .L2
        }                                  │        movl    $1, -4(%rbp)
}                                          │.L2:
~                                          │        cmpl    $0, -8(%rbp)
~                                          │        jne     .L3
</code></pre>
<p>This assembly code says the following to the CPU:</p>
<p>Jump to L2.<br>
L3: <strong>load</strong> value of <em>flag</em> from memory, compare it to $0, if they aren&rsquo;t equal jump to L2 else <strong>store</strong> 1 into flag&rsquo;s memory address and then jump to L2.<br>
L2: <strong>load</strong> value of <em>condition</em> from memory, compare it to 0, if they aren&rsquo;t equal jump to L3, else exit.</p>
<p>Why did I write in bold &ldquo;load&rdquo; and &ldquo;store&rdquo;? Because they represent <em>accesses to memory</em> and these are the most expensive type of instructions for a CPU. Memory response times are generally an order of magnitude higher than CPU elaboration times, therefore <strong>memory accessess represent a bottleneck for process performance</strong>.</p>
<p>In this version of the program we have 3 accesses to memory in case flag equals 0 (two loads and one store) and 2 accesses in case flag equals 1(only two loads).</p>
<p>Notice that we also have two jump instructions inside the loop, one to stay inside it until condition equals 0 and one to skip the assigment if flag is already equal to 1.</p>
<h3 id="second-version---set-to-1-dont-bother-with-checking-the-previous-value">Second version - Set to 1, don&rsquo;t bother with checking the previous value</h3>
<pre><code>int main(){                               │        movl    $42, -4(%rbp)
        int condition = 42;               │        movl    $0, -8(%rbp)
        int flag = 0;                     │        jmp     .L2
        while(condition){                 │.L3:
                flag = 1;                 │        movl    $1, -8(%rbp)
        }                                 │.L2:
}                                         │        cmpl    $0, -4(%rbp)
~                                         │        jne     .L3
</code></pre>
<p>In this second version the assembly code says:</p>
<p>Jump to L2.<br>
L3: <strong>store</strong> 1 into <em>flag</em>&rsquo;s memory address.<br>
L2: <strong>load</strong> value of <em>condition</em> from memory, compare it to 0, if they aren&rsquo;t equal jump to L3, else exit.</p>
<p>Here we have only one load and one store per iteration, so only two memory accesses whether the flag value is 0 or 1. Also, notice that the only jump instruction is the one necessary to stay inside the loop if the variable <em>condition</em> isn&rsquo;t equal to 0.</p>
<h3 id="so-which-version-is-better">So, which version is better?</h3>
<p>Since the second version implies only two memory accesses against three of the first version in case flag equals 0 and also one less jump instruction, in <em>most real case scenarios</em> it would the right choice if performance is a concern.</p>
<p>Notice I labeled <em>load</em> and <em>store</em> generically as <em>memory access</em> instructions. This because the two instructions generally require the same computation time. But&hellip; what if the store instruction was way more expensive than the load instruction? In this particular case the first version would have been better but I personally don&rsquo;t know any real case in which this happens to be true.</p>
<h6 id="ps-dont-take-me-for-a-source-of-absolute-truth-on-these-topics-some-information-here-could-be-misleading-or-i-hope-not-wrong-at-all-in-both-cases-please-send-me-an-email-and-let-me-know-ill-be-happy-to-learn-something-new-and-to-correct-the-post"><em>PS: Don&rsquo;t take me for a source of absolute truth on these topics, some information here could be misleading or (I hope not&hellip;) wrong at all. In both cases please send me an email and let me know, I&rsquo;ll be happy to learn something new and to correct the post.</em></h6>
<hr>
<h3 id="update-260819---c-compiler-optimizations">Update 26/08/19 - C Compiler Optimizations</h3>
<p>It&rsquo;s interesting to observe that in a &ldquo;real&rdquo; program like the following one, compiling  with gcc -O3 (level 3 optimizations enabled) yields to the same identical assembly code for both versions.</p>
<pre><code>$ cat ex-v1.c
#include &lt;stdio.h&gt;
#define	IN	1
#define	OUT	0
int main(){
    int c;
    int state;
    while((c = getchar()) != EOF){
        if(c == '\n' || c == '\t' || c == ' '){
            if(state == IN){
                putchar('\n');
                state = OUT;
            }
        }
        else{
            if(state == OUT)
                state = IN;
            putchar(c);
        }
    }
    return 0;
}
$ cat ex-v2.c
#include &lt;stdio.h&gt;
#define	IN	1
#define	OUT	0
int main(){
    int c;
    int state;
    while((c = getchar()) != EOF){
        if(c == '\n' || c == '\t' || c == ' '){
            if(state == IN){
                putchar('\n');
                state = OUT;
            }
        }
        else{
            state = IN;
            putchar(c);
        }
    }
    return 0;
}
$ gcc -O3 -S ex-v1.c ex-v2.c &amp;&amp; diff ex-v1.s ex-v2.s
1c1
&lt; 	.file	&quot;ex-v1.c&quot;
---
&gt; 	.file	&quot;ex-v2.c&quot; 
</code></pre>

            </div>

            <section class="webring">
  <h3>Articles from blogs I follow around the net</h3>
  <section class="articles">
    
    <div class="article">
      <h4 class="title">
	<a href="https://drewdevault.com/2021/01/07/History-will-not-remember-us-fondly.html" target="_blank" rel="noopener">History will not remember us fondly</a>
      </h4>
      <p class="summary">Today, we recall the Middle Ages as an unenlightened time (quite literally, in
fact). We view the Middle Ages with a critical eye towards its brutality, lack
of individual freedoms, and societal and technological regression. But we rarely
turn that same crit…</p>
      <small class="source">
	via <a href="https://drewdevault.com">Drew DeVault&#39;s blog</a>
      </small>
      <small class="date">January 7, 2021</small>
    </div>
    
    <div class="article">
      <h4 class="title">
	<a href="https://nullprogram.com/blog/2020/12/31/" target="_blank" rel="noopener">State machines are wonderful tools</a>
      </h4>
      <p class="summary">
      This article was discussed on Hacker News.

I love when my current problem can be solved with a state machine. They’re
fun to design and implement, and I have high confidence about correctness.
They tend to:


  Present minimal, tidy interfaces
  Require fe…</p>
      <small class="source">
	via <a href="https://nullprogram.com">null program</a>
      </small>
      <small class="date">December 31, 2020</small>
    </div>
    
    <div class="article">
      <h4 class="title">
	<a href="https://danluu.com/essential-complexity/" target="_blank" rel="noopener">Against essential and accidental complexity</a>
      </h4>
      <p class="summary">

In the classic 1986 essay, No Silver Bullet, Fred Brooks argued that there is, in some sense, not that much that can be done to improve programmer productivity. His line of reasoning is that programming tasks contain a core of essential/conceptual1 comple…</p>
      <small class="source">
	via <a href="https://danluu.com/atom/index.xml">Dan Luu</a>
      </small>
      <small class="date">December 29, 2020</small>
    </div>
    
  </section>
  <p class="attribution">
    Generated by
    <a href="https://git.sr.ht/~sircmpwn/openring">openring</a>
  </p>
</section>


            
            <br>
            <div class="navigation">
                
                <div>
                    <img class="icon" src="https://glumia.github.io/img/back.svg" alt="back" />
                    <a href="https://glumia.github.io/blog/gog-store-overkill-search/">GOG Store - Overkill search</a>
                </div>
                
                <div style="width: 100%;"></div>
                
                <div>
                    <a href="https://glumia.github.io/blog/the-levenshtein-distance/">The Levenshtein Distance</a>
                    <img class="icon" src="https://glumia.github.io/img/next.svg" alt="next" />
                </div>
                
            </div>
            
        </div>
    </div>
</div>



<div class="footer column">
    <div class="container">

        

        

        <div class="copyright">

        
            
                <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0 © 2021 Giuseppe Lumia</a>
            
        

        </div>
        <div class="icons">

        

        
            <a href="https://github.com/glumia" rel=me target="_blank">
                <img class="icon" src="https://glumia.github.io/img/github.svg" alt="github" />
            </a>
        

        
            <a href="https://twitter.com/glumia8" rel=me target="_blank">
                <img class="icon" src="https://glumia.github.io/img/twitter.svg" alt="twitter" />
            </a>
        

        
            <a href="https://www.linkedin.com/in/glumia" rel=me target="_blank">
                <img class="icon" src="https://glumia.github.io/img/linkedin.svg" alt="linkedin" />
            </a>
        

        
            <a href="https://keybase.io/glumia" rel=me target="_blank">
                <img class="icon" src="https://glumia.github.io/img/keybase.svg" alt="keybase" />
            </a>
        


        
            <a href="mailto:g.lumia@outlook.com">
                <img class="icon" src="https://glumia.github.io/img/email.svg" alt="email" />
            </a>
        

        
            <a href="https://glumia.github.io/index.xml">
                <img class="icon" src="https://glumia.github.io/img/rss.svg" alt="rss" />
            </a>
        

        </div>
    </div>
</div>
</body>
</html>

